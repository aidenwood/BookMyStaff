import{c as u,p as c,s as t}from"./supabase.B1wfRk4O.js";const o=u()(c((s,i)=>({user:null,isAuthenticated:!1,isLoading:!0,token:null,error:null,login:async r=>{s({isLoading:!0,error:null});try{const{data:e,error:a}=await t.auth.signInWithPassword({email:r.email,password:r.password});if(a)return s({error:a.message,isLoading:!1}),!1;if(e.user){const n=await i().fetchUserProfile(e.user.id);return s({user:n,token:e.session?.access_token||null,isAuthenticated:!0,isLoading:!1,error:null}),!0}return!1}catch{return s({error:"Login failed. Please try again.",isLoading:!1}),!1}},loginWithOAuth:async r=>{s({isLoading:!0,error:null});try{const{data:e,error:a}=await t.auth.signInWithOAuth({provider:r,options:{redirectTo:`${window.location.origin}/auth/callback`}});return a?(s({error:a.message,isLoading:!1}),!1):!0}catch{return s({error:"OAuth login failed. Please try again.",isLoading:!1}),!1}},register:async r=>{s({isLoading:!0,error:null});try{const{data:e,error:a}=await t.auth.signUp({email:r.email,password:r.password,options:{data:{name:r.name,business_name:r.businessName,phone:r.phone}}});if(a)return s({error:a.message,isLoading:!1}),!1;if(e.user){await i().createUserProfile(e.user.id,r);const n=await i().fetchUserProfile(e.user.id);return s({user:n,token:e.session?.access_token||null,isAuthenticated:!0,isLoading:!1,error:null}),!0}return!1}catch{return s({error:"Registration failed. Please try again.",isLoading:!1}),!1}},logout:async()=>{await t.auth.signOut(),s({user:null,token:null,isAuthenticated:!1,error:null})},checkAuth:async()=>{try{const{data:r,error:e}=await t.auth.getSession();if(e){s({isLoading:!1});return}if(r.session?.user){const a=await i().fetchUserProfile(r.session.user.id);s({user:a,token:r.session.access_token,isAuthenticated:!0,isLoading:!1,error:null})}else s({user:null,token:null,isAuthenticated:!1,isLoading:!1})}catch{s({user:null,token:null,isAuthenticated:!1,isLoading:!1})}},resetPassword:async r=>{try{const{error:e}=await t.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/auth/reset-password`});return!e}catch{return!1}},updatePassword:async r=>{try{const{error:e}=await t.auth.updateUser({password:r});return!e}catch{return!1}},updateUser:r=>{const e=i().user;e&&s({user:{...e,...r}})},clearError:()=>s({error:null}),fetchUserProfile:async r=>{try{const{data:e,error:a}=await t.from("staff_members").select(`
              *,
              businesses (*)
            `).eq("id",r).single();if(a||!e){const{data:n}=await t.auth.getUser();return{id:r,email:n.user?.email||"",name:n.user?.user_metadata?.name||"",role:"business_owner",isActive:!0,createdAt:new Date().toISOString()}}return{id:e.id,email:e.email,name:e.name,role:e.role,businessId:e.business_id,avatar:e.avatar,phone:e.phone,isActive:e.is_active,createdAt:e.created_at}}catch(e){return console.error("Error fetching user profile:",e),null}},createUserProfile:async(r,e)=>{try{const{data:a,error:n}=await t.from("businesses").insert({name:e.businessName,email:e.email,phone:e.phone,owner_id:r,industry_id:"other"}).select().single();if(n)throw n;const{error:l}=await t.from("staff_members").insert({id:r,business_id:a.id,name:e.name,email:e.email,phone:e.phone,role:"owner"});if(l)throw l}catch(a){console.error("Error creating user profile:",a)}}}),{name:"auth-storage",partialize:s=>({token:s.token,user:s.user,isAuthenticated:s.isAuthenticated})}));t.auth.onAuthStateChange((s,i)=>{const r=o.getState();s==="SIGNED_IN"&&i?r.fetchUserProfile(i.user.id).then(e=>{e&&o.setState({user:e,token:i.access_token,isAuthenticated:!0,isLoading:!1,error:null})}):s==="SIGNED_OUT"&&o.setState({user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null})});export{o as u};
